<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <title>JH Agent Factory v2 — Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    :root { --bg-0:#0a0a0c; --bg-1:#111114; --bg-2:#19191e; --border:#222228;
      --accent:#ff6b2b; --accent2:#6366F1; --green:#34D399; --red:#EF4444; --yellow:#FBBF24;
      --text:#CBD5E1; --text2:#6B7A90; --text3:#3A3F4B;
      --mobile-nav-h:56px; --safe-bottom:env(safe-area-inset-bottom, 0px); }
    body { background:var(--bg-0); color:var(--text); font-family:'DM Mono','IBM Plex Mono',monospace; font-size:13px; overflow:hidden; height:100vh; }
    #loading { position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; background:var(--bg-0); color:var(--accent); font-family:'Syne',sans-serif; z-index:9999; }
    #loading .spinner { width:40px; height:40px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin .8s linear infinite; margin-bottom:16px; }
    @keyframes spin { to { transform:rotate(360deg) } }
    @keyframes pulse { 0%,100%{opacity:.4} 50%{opacity:1} }
    @keyframes dotBounce { 0%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-4px)} }
    @keyframes slideUp { from{transform:translateY(100%);opacity:0} to{transform:translateY(0);opacity:1} }
    @keyframes slideFromRight { from{transform:translateX(100%)} to{transform:translateX(0)} }
    @keyframes slideFromLeft { from{transform:translateX(-100%)} to{transform:translateX(0)} }
    ::selection { background:#ff6b2b33; color:#E2E8F0 }
    ::-webkit-scrollbar { width:4px }
    ::-webkit-scrollbar-track { background:transparent }
    ::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px }
    textarea { font-family:inherit; }

    /* ─── MOBILE RESPONSIVE ─── */
    @media (max-width: 768px) {
      body { overflow:auto; }
      .desktop-only { display:none !important; }
      .mobile-body { flex-direction:column !important; }
      .mobile-body > aside { display:none !important; }
      .mobile-body > main { min-height:calc(100vh - 48px - var(--mobile-nav-h) - var(--safe-bottom)) !important; }
      .mobile-sidebar-overlay {
        position:fixed; inset:0; z-index:50;
        background:#00000088; backdrop-filter:blur(4px);
      }
      .mobile-sidebar-panel {
        position:fixed; top:0; left:0; bottom:0; width:85%; max-width:320px; z-index:51;
        background:var(--bg-1); border-right:1px solid var(--border);
        display:flex; flex-direction:column; animation:slideFromLeft .25s ease;
        transform-origin:left;
      }
      .mobile-right-overlay {
        position:fixed; inset:0; z-index:50;
        background:#00000088; backdrop-filter:blur(4px);
      }
      .mobile-right-panel {
        position:fixed; top:0; right:0; bottom:0; width:90%; max-width:380px; z-index:51;
        background:var(--bg-1); border-left:1px solid var(--border);
        display:flex; flex-direction:column; overflow-y:auto;
        animation:slideFromRight .25s ease;
      }
      .mobile-bottom-nav {
        position:fixed; bottom:0; left:0; right:0; z-index:40;
        height:calc(var(--mobile-nav-h) + var(--safe-bottom));
        padding-bottom:var(--safe-bottom);
        background:var(--bg-1); border-top:1px solid var(--border);
        display:flex; align-items:center; justify-content:space-around;
        backdrop-filter:blur(12px);
      }
      .mobile-bottom-nav button {
        flex:1; display:flex; flex-direction:column; align-items:center; gap:3px;
        padding:8px 0; background:none; border:none; cursor:pointer;
        font-family:inherit; font-size:9px; letter-spacing:.04em;
        color:var(--text3); transition:color .15s;
      }
      .mobile-bottom-nav button.active { color:var(--accent); }
      .mobile-bottom-nav button .nav-icon { font-size:18px; font-family:Syne; font-weight:700; line-height:1; }
      .mobile-chat-input { padding-bottom:calc(var(--mobile-nav-h) + var(--safe-bottom) + 12px) !important; }
      .mobile-header-compact .header-detail { display:none !important; }
    }
    @media (min-width: 769px) {
      .mobile-only { display:none !important; }
      .mobile-bottom-nav { display:none !important; }
      .mobile-sidebar-overlay, .mobile-sidebar-panel,
      .mobile-right-overlay, .mobile-right-panel { display:none !important; }
    }
    /* ─── TOUCH TARGETS ─── */
    @media (pointer: coarse) {
      button { min-height:44px; }
      input, textarea, select { min-height:44px; font-size:16px !important; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="loading"><div class="spinner"></div><div>LOADING FACTORY v2...</div></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-type="module">
    const { useState, useEffect, useRef, useCallback } = React;
    const API = window.location.origin;

    const ICON_MAP = {
      log_analyzer:"◉", api_reconnector:"⟳", agent_builder:"⬡",
      resource_monitor:"▦", data_processor:"⟐", nlp_basic:"◬",
      scheduler:"◷", memory_compressor:"◈", example_echo:"↻",
    };
    const CAT_COLOR = {
      monitoring:"#06B6D4", network:"#FB923C", factory:"#6366F1",
      data:"#34D399", ai:"#A78BFA", automation:"#FBBF24",
      memory:"#F472B6", utility:"#64748B", custom:"#64748B",
    };
    const ROLES = [
      { v:"general",         l:"범용",       ic:"◇", color:"#64748B" },
      { v:"data_analyst",    l:"데이터",     ic:"▦", color:"#06B6D4" },
      { v:"content_creator", l:"콘텐츠",     ic:"◬", color:"#F472B6" },
      { v:"monitor",         l:"모니터링",   ic:"◉", color:"#34D399" },
      { v:"trader",          l:"트레이딩",   ic:"△", color:"#FBBF24" },
      { v:"researcher",      l:"리서치",     ic:"⟐", color:"#A78BFA" },
      { v:"automation",      l:"자동화",     ic:"⟳", color:"#FB923C" },
      { v:"security",        l:"보안",       ic:"⬡", color:"#EF4444" },
    ];

    const getColor = (a) => {
      if (a.role === "master_controller") return "#ff6b2b";
      const r = ROLES.find(r => r.v === a.role);
      return r ? r.color : "#64748B";
    };
    const getIcon = (a) => {
      if (a.role === "master_controller") return "★";
      return a.metadata?.icon || "◇";
    };

    // ─── MOBILE DETECTION HOOK ─────────────────────
    function useIsMobile(breakpoint = 768) {
      const [isMobile, setIsMobile] = useState(() => window.innerWidth <= breakpoint);
      useEffect(() => {
        const onResize = () => setIsMobile(window.innerWidth <= breakpoint);
        window.addEventListener("resize", onResize);
        return () => window.removeEventListener("resize", onResize);
      }, [breakpoint]);
      return isMobile;
    }

    // ─── MAIN APP ───────────────────────────────────
    function App() {
      const [agents, setAgents] = useState([]);
      const [skills, setSkills] = useState([]);
      const [catalog, setCatalog] = useState([]);
      const [selId, setSelId] = useState(null);
      const [routerStatus, setRouterStatus] = useState(null);
      const [showCreateModal, setShowCreateModal] = useState(false);

      // Chat state
      const [chatMsgs, setChatMsgs] = useState([]);
      const [chatInput, setChatInput] = useState("");
      const [chatLoading, setChatLoading] = useState(false);
      const [sessionId] = useState(() => "s_" + Date.now());
      const chatEndRef = useRef(null);
      const inputRef = useRef(null);

      // Mobile state
      const isMobile = useIsMobile();
      const [mobileTab, setMobileTab] = useState("chat"); // chat | agents | panel
      const [showMobileSidebar, setShowMobileSidebar] = useState(false);
      const [showMobilePanel, setShowMobilePanel] = useState(false);

      const refreshAgents = () => fetch(`${API}/api/agents`).then(r=>r.json()).then(d=>setAgents(d.agents||[]));
      const refreshAgent = (id) => fetch(`${API}/api/agents/${id}`).then(r=>r.json()).then(a => setAgents(prev => prev.map(x => x.agent_id===id ? a : x)));

      useEffect(() => {
        refreshAgents();
        fetch(`${API}/api/skills`).then(r=>r.json()).then(d=>setSkills(d.skills||[]));
        fetch(`${API}/api/skills/catalog`).then(r=>r.json()).then(d=>{
          const s = d.skills || {};
          setCatalog(Object.values(s));
        }).catch(()=>{});
        fetch(`${API}/api/router/status`).then(r=>r.json()).then(setRouterStatus).catch(()=>{});
        document.getElementById("loading").style.display = "none";
      }, []);

      useEffect(() => { chatEndRef.current?.scrollIntoView({behavior:"smooth"}); }, [chatMsgs, chatLoading]);

      const selAgent = selId ? agents.find(a=>a.agent_id===selId) : null;
      const master = agents.find(a=>a.role==="master_controller");
      const activeProvider = routerStatus?.providers?.find(p=>p.available);

      // Mobile: auto-open panel when selecting an agent from sidebar
      const selectAgent = (id) => {
        setSelId(id);
        if (isMobile) {
          setShowMobileSidebar(false);
          setShowMobilePanel(true);
          setMobileTab("panel");
        }
      };

      // ─── Chat ─────────────────────────────────────
      const sendChat = async () => {
        const msg = chatInput.trim();
        if (!msg || chatLoading) return;
        setChatInput("");
        setChatMsgs(prev => [...prev, {role:"user", content:msg}]);
        setChatLoading(true);
        try {
          const res = await fetch(`${API}/api/chat`, {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify({message:msg, session_id:sessionId})
          });
          const data = await res.json();
          if (data.error && !data.reply) {
            setChatMsgs(prev => [...prev, {role:"error", content: data.error}]);
          } else {
            setChatMsgs(prev => [...prev, {
              role:"assistant", content:data.reply, provider:data.provider, model:data.model,
              hadCommands: data.had_commands, commandsExecuted: data.commands_executed
            }]);
            // 명령 실행 시 에이전트/스킬 갱신
            if (data.had_commands) { refreshAgents(); }
          }
        } catch(e) {
          setChatMsgs(prev => [...prev, {role:"error", content:"네트워크 오류"}]);
        }
        setChatLoading(false);
      };

      const onKeyDown = (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendChat(); }
      };

      // ─── Agent actions ────────────────────────────
      const doEquip = (agentId, skillId) => {
        fetch(`${API}/api/agents/${agentId}/skills`, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({skill_id:skillId})
        }).then(r=>r.json()).then(d=>{ if(d.success) refreshAgent(agentId); });
      };
      const doUnequip = (agentId, skillId) => {
        fetch(`${API}/api/agents/${agentId}/skills/${skillId}`, {method:"DELETE"})
          .then(r=>r.json()).then(d=>{ if(d.success) refreshAgent(agentId); });
      };
      const doLevelUp = (agentId, force) => {
        fetch(`${API}/api/agents/${agentId}/levelup`, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({force})
        }).then(r=>r.json()).then(d=>{
          if(d.success) { refreshAgent(agentId); refreshAgents(); }
          else alert(d.message);
        });
      };
      const doDelete = (agentId) => {
        if(!confirm("정말 삭제하시겠습니까?")) return;
        fetch(`${API}/api/agents/${agentId}`, {method:"DELETE"})
          .then(r=>r.json()).then(d=>{
            if(d.success) { setSelId(null); refreshAgents(); }
            else alert(d.detail || d.message);
          });
      };
      const doCreate = (name, role, isMaster) => {
        fetch(`${API}/api/agents/create`, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({name, role, is_master:isMaster})
        }).then(r=>r.json()).then(d=>{
          if(d.success!==false) { refreshAgents(); setShowCreateModal(false); }
          else alert(d.message||"생성 실패");
        });
      };

      // ═══════════════════════════════════════════════
      // RENDER
      // ═══════════════════════════════════════════════
      return (
        <div style={{height:"100vh", display:"flex", flexDirection:"column", background:"var(--bg-0)"}}>

          {/* ── HEADER ── */}
          <header className={isMobile ? "mobile-header-compact" : ""} style={{
            height:48, padding: isMobile ? "0 12px" : "0 20px", display:"flex", alignItems:"center", justifyContent:"space-between",
            borderBottom:"1px solid var(--border)", background:"var(--bg-0)", flexShrink:0, zIndex:20
          }}>
            <div style={{display:"flex", alignItems:"center", gap: isMobile ? 8 : 12}}>
              <div style={{width:28,height:28,borderRadius:7,border:"1.5px solid #ff6b2b55",display:"flex",alignItems:"center",justifyContent:"center",fontSize:13,fontWeight:700,color:"var(--accent)",fontFamily:"Syne"}}>JH</div>
              <span style={{fontFamily:"Syne",fontWeight:700,fontSize: isMobile ? 13 : 14,color:"#E2E8F0"}}>AGENT FACTORY</span>
              <span className="header-detail" style={{fontSize:9,color:"var(--text3)",letterSpacing:".1em"}}>v2.2</span>
            </div>
            <div style={{display:"flex",alignItems:"center",gap: isMobile ? 8 : 14,fontSize:10,color:"var(--text2)"}}>
              {activeProvider && (
                <div className="header-detail" style={{display:"flex",alignItems:"center",gap:5}}>
                  <span style={{width:5,height:5,borderRadius:3,background:"var(--green)",display:"inline-block",animation:"pulse 2s ease infinite"}} />
                  <span>AI: {activeProvider.name}</span>
                </div>
              )}
              <span>{agents.length} agents</span>
              <span className="header-detail">{skills.length} skills</span>
            </div>
          </header>

          {/* ── BODY: sidebar + main + panel ── */}
          <div className="mobile-body" style={{flex:1, display:"flex", overflow:"hidden"}}>

            {/* ── SIDEBAR 280px (desktop) ── */}
            <aside className="desktop-only" style={{width:280, borderRight:"1px solid var(--border)", background:"var(--bg-1)", display:"flex", flexDirection:"column", flexShrink:0}}>
              <AgentSidebar agents={agents} selId={selId} onSelect={selectAgent} onCreateClick={()=>setShowCreateModal(true)} />
            </aside>

            {/* ── MOBILE SIDEBAR OVERLAY ── */}
            {isMobile && showMobileSidebar && (
              <>
                <div className="mobile-sidebar-overlay" onClick={()=>setShowMobileSidebar(false)} />
                <div className="mobile-sidebar-panel">
                  <AgentSidebar agents={agents} selId={selId} onSelect={selectAgent} onCreateClick={()=>{setShowCreateModal(true);setShowMobileSidebar(false);}} />
                </div>
              </>
            )}

            {/* ── MAIN: CHAT ── */}
            <main style={{flex:1, display:"flex", flexDirection:"column", background:"var(--bg-0)", minWidth:0}}>
              {/* Chat header */}
              <div style={{padding: isMobile ? "10px 14px" : "12px 20px", borderBottom:"1px solid var(--border)", display:"flex", alignItems:"center", gap:10}}>
                <span style={{fontSize:18,fontFamily:"Syne",fontWeight:800,color:"var(--accent)"}}>★</span>
                <div style={{flex:1}}>
                  <div style={{fontFamily:"Syne",fontWeight:700,fontSize: isMobile ? 13 : 14,color:"#E2E8F0"}}>{master?.name || "춘식이"} 채팅</div>
                  <div style={{fontSize:9,color:"var(--text3)"}}>마스터 에이전트와 대화</div>
                </div>
                {isMobile && selAgent && (
                  <button onClick={()=>{setShowMobilePanel(true);setMobileTab("panel");}}
                    style={{padding:"6px 10px",borderRadius:8,border:"1px solid var(--border)",background:"var(--bg-2)",color:getColor(selAgent),cursor:"pointer",fontSize:11,fontFamily:"Syne",fontWeight:700,display:"flex",alignItems:"center",gap:4}}>
                    {getIcon(selAgent)} <span style={{fontSize:9,color:"var(--text2)"}}>{selAgent.name}</span>
                  </button>
                )}
              </div>

              {/* Messages */}
              <div style={{flex:1, overflowY:"auto", padding: isMobile ? "14px 12px" : "20px"}}>
                {chatMsgs.length === 0 && (
                  <div style={{textAlign:"center",marginTop: isMobile ? 40 : 80}}>
                    <div style={{fontSize: isMobile ? 36 : 48,marginBottom:16}}>★</div>
                    <div style={{fontFamily:"Syne",fontWeight:700,fontSize: isMobile ? 15 : 18,color:"var(--text2)",marginBottom:8}}>춘식이에게 말을 걸어보세요</div>
                    <div style={{fontSize:11,color:"var(--text3)",lineHeight:1.8}}>
                      JH Agent Factory의 마스터 에이전트가 응답합니다.<br/>
                      Enter로 전송 · Shift+Enter로 줄바꿈
                    </div>
                  </div>
                )}
                {chatMsgs.map((m,i) => (
                  <div key={i} style={{
                    display:"flex", justifyContent: m.role==="user" ? "flex-end" : "flex-start",
                    marginBottom:12
                  }}>
                    <div style={{
                      maxWidth: isMobile ? "85%" : "70%", padding: isMobile ? "10px 14px" : "12px 16px", borderRadius:14,
                      background: m.role==="user" ? "var(--accent)" : m.role==="error" ? "#EF44441A" : "var(--bg-2)",
                      color: m.role==="user" ? "#fff" : m.role==="error" ? "var(--red)" : "var(--text)",
                      fontSize:13, lineHeight:1.7, whiteSpace:"pre-wrap", wordBreak:"break-word",
                      borderBottomRightRadius: m.role==="user" ? 4 : 14,
                      borderBottomLeftRadius: m.role==="user" ? 14 : 4,
                    }}>
                      {m.content}
                      {m.hadCommands && m.commandsExecuted && (
                        <div style={{marginTop:8,display:"flex",flexWrap:"wrap",gap:4}}>
                          {m.commandsExecuted.map((c,ci) => (
                            <span key={ci} style={{
                              display:"inline-block",padding:"2px 6px",borderRadius:4,fontSize:10,
                              background: c.result?.success ? "#34D39914" : "#EF444414",
                              border: `1px solid ${c.result?.success ? "var(--green)" : "var(--red)"}`,
                              color: c.result?.success ? "var(--green)" : "var(--red)"
                            }}>{c.result?.success ? "✓" : "✕"} {c.command}</span>
                          ))}
                        </div>
                      )}
                      {m.provider && (
                        <div style={{marginTop:6,fontSize:9,color: m.role==="user" ? "#ffffff88" : "var(--text3)"}}>
                          via {m.provider} · {m.model}
                        </div>
                      )}
                    </div>
                  </div>
                ))}
                {chatLoading && (
                  <div style={{display:"flex",justifyContent:"flex-start",marginBottom:12}}>
                    <div style={{padding:"12px 20px",borderRadius:14,background:"var(--bg-2)",borderBottomLeftRadius:4,display:"flex",gap:4,alignItems:"center"}}>
                      {[0,1,2].map(i => (
                        <span key={i} style={{width:6,height:6,borderRadius:3,background:"var(--accent)",display:"inline-block",animation:`dotBounce .6s ${i*.15}s ease infinite`}} />
                      ))}
                      <span style={{fontSize:10,color:"var(--text2)",marginLeft:8}}>춘식이 생각 중...</span>
                    </div>
                  </div>
                )}
                <div ref={chatEndRef} />
              </div>

              {/* Input */}
              <div className={isMobile ? "mobile-chat-input" : ""} style={{padding: isMobile ? "10px 12px" : "12px 20px", borderTop:"1px solid var(--border)"}}>
                <div style={{display:"flex",gap:8,alignItems:"flex-end"}}>
                  <textarea ref={inputRef} value={chatInput} onChange={e=>setChatInput(e.target.value)} onKeyDown={onKeyDown}
                    placeholder="춘식이에게 메시지 보내기..."
                    rows={1}
                    style={{
                      flex:1, padding:"12px 16px", borderRadius:12,
                      border:"1.5px solid var(--border)", background:"var(--bg-1)",
                      color:"#E2E8F0", fontSize:13, fontFamily:"inherit",
                      outline:"none", resize:"none", minHeight:44, maxHeight:120,
                      transition:"border-color .2s"
                    }}
                    onFocus={e=>e.target.style.borderColor="#ff6b2b55"}
                    onBlur={e=>e.target.style.borderColor="var(--border)"}
                    onInput={e=>{e.target.style.height="auto"; e.target.style.height=Math.min(e.target.scrollHeight,120)+"px";}} />
                  <button onClick={sendChat} disabled={chatLoading || !chatInput.trim()}
                    style={{
                      padding:"12px 20px", borderRadius:12, border:"none",
                      background: chatInput.trim() && !chatLoading ? "var(--accent)" : "var(--border)",
                      color: chatInput.trim() && !chatLoading ? "#fff" : "var(--text3)",
                      cursor: chatInput.trim() && !chatLoading ? "pointer" : "default",
                      fontFamily:"Syne", fontWeight:700, fontSize:13, flexShrink:0,
                      transition:"all .2s"
                    }}>▸</button>
                </div>
              </div>
            </main>

            {/* ── RIGHT PANEL 320px (desktop) ── */}
            <aside className="desktop-only" style={{width:320, borderLeft:"1px solid var(--border)", background:"var(--bg-1)", display:"flex", flexDirection:"column", flexShrink:0, overflowY:"auto"}}>
              {selAgent ? (
                <AgentPanel agent={selAgent} skills={skills} catalog={catalog}
                  onEquip={doEquip} onUnequip={doUnequip} onLevelUp={doLevelUp} onDelete={doDelete} onRefreshAgents={refreshAgents} />
              ) : (
                <div style={{flex:1,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:12,color:"var(--text3)"}}>
                  <span style={{fontSize:32}}>◇</span>
                  <span style={{fontSize:11}}>좌측에서 에이전트를 선택하세요</span>
                </div>
              )}
            </aside>

            {/* ── MOBILE RIGHT PANEL OVERLAY ── */}
            {isMobile && showMobilePanel && (
              <>
                <div className="mobile-right-overlay" onClick={()=>setShowMobilePanel(false)} />
                <div className="mobile-right-panel">
                  <div style={{padding:"12px 16px",borderBottom:"1px solid var(--border)",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                    <span style={{fontSize:11,color:"var(--text2)",fontWeight:600,letterSpacing:".08em"}}>AGENT DETAIL</span>
                    <button onClick={()=>setShowMobilePanel(false)}
                      style={{padding:"6px 12px",borderRadius:6,border:"1px solid var(--border)",background:"transparent",color:"var(--text2)",cursor:"pointer",fontSize:11,fontFamily:"inherit"}}>
                      닫기
                    </button>
                  </div>
                  {selAgent ? (
                    <AgentPanel agent={selAgent} skills={skills} catalog={catalog}
                      onEquip={doEquip} onUnequip={doUnequip} onLevelUp={doLevelUp}
                      onDelete={(id)=>{doDelete(id);setShowMobilePanel(false);}} onRefreshAgents={refreshAgents} />
                  ) : (
                    <div style={{flex:1,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:12,color:"var(--text3)",padding:40}}>
                      <span style={{fontSize:32}}>◇</span>
                      <span style={{fontSize:11}}>에이전트를 선택하세요</span>
                    </div>
                  )}
                </div>
              </>
            )}
          </div>

          {/* ── MOBILE BOTTOM NAV ── */}
          {isMobile && (
            <div className="mobile-bottom-nav">
              <button className={mobileTab==="chat" ? "active" : ""} onClick={()=>{setMobileTab("chat");setShowMobileSidebar(false);setShowMobilePanel(false);}}>
                <span className="nav-icon">★</span>
                <span>채팅</span>
              </button>
              <button className={mobileTab==="agents" || showMobileSidebar ? "active" : ""} onClick={()=>{setMobileTab("agents");setShowMobileSidebar(true);setShowMobilePanel(false);}}>
                <span className="nav-icon">◇</span>
                <span>에이전트</span>
              </button>
              <button className={mobileTab==="panel" || showMobilePanel ? "active" : ""} onClick={()=>{setMobileTab("panel");setShowMobilePanel(true);setShowMobileSidebar(false);}}>
                <span className="nav-icon">▦</span>
                <span>상세</span>
              </button>
              <button onClick={()=>setShowCreateModal(true)}>
                <span className="nav-icon" style={{color:"var(--accent)"}}>+</span>
                <span>생산</span>
              </button>
            </div>
          )}

          {/* ── CREATE MODAL ── */}
          {showCreateModal && <CreateModal onClose={()=>setShowCreateModal(false)} onCreate={doCreate} hasMaster={!!master} />}
        </div>
      );
    }

    // ═══════════════════════════════════════════════════
    // AGENT SIDEBAR (extracted for desktop + mobile reuse)
    // ═══════════════════════════════════════════════════
    function AgentSidebar({ agents, selId, onSelect, onCreateClick }) {
      return (
        <>
          <div style={{padding:"14px 16px 10px", display:"flex", alignItems:"center", justifyContent:"space-between", borderBottom:"1px solid var(--border)"}}>
            <span style={{fontSize:9,color:"var(--text2)",letterSpacing:".12em",fontWeight:600}}>AGENTS ({agents.length})</span>
            <button onClick={onCreateClick}
              style={{padding:"4px 10px",borderRadius:6,border:"1px solid var(--border)",background:"transparent",color:"var(--accent)",cursor:"pointer",fontSize:10,fontFamily:"inherit"}}>
              + 생산
            </button>
          </div>
          <div style={{flex:1, overflowY:"auto", padding:"8px"}}>
            {agents.length === 0 && (
              <div style={{textAlign:"center",padding:"32px 12px",color:"var(--text3)"}}>
                <div style={{fontSize:28,marginBottom:8,opacity:.3}}>◇</div>
                <div style={{fontSize:10}}>에이전트가 없습니다</div>
              </div>
            )}
            {agents.map(a => {
              const c = getColor(a);
              const ic = getIcon(a);
              const isSel = selId === a.agent_id;
              const isMasterAgent = a.role === "master_controller";
              return (
                <div key={a.agent_id} onClick={()=>onSelect(a.agent_id)}
                  style={{
                    padding:"12px 14px", borderRadius:10, marginBottom:4, cursor:"pointer",
                    background: isSel ? "var(--bg-2)" : "transparent",
                    borderLeft: isMasterAgent ? "3px solid var(--accent)" : "3px solid transparent",
                    transition:"all .15s"
                  }}
                  onMouseOver={e=>{if(!isSel) e.currentTarget.style.background="var(--bg-2)"}}
                  onMouseOut={e=>{if(!isSel) e.currentTarget.style.background="transparent"}}>
                  <div style={{display:"flex",alignItems:"center",gap:10}}>
                    <div style={{width:36,height:36,borderRadius:10,border:`1.5px solid ${c}33`,background:`${c}0A`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:16,fontWeight:700,color:c,fontFamily:"Syne"}}>{ic}</div>
                    <div style={{flex:1,minWidth:0}}>
                      <div style={{fontFamily:"Syne",fontWeight:600,fontSize:13,color:"#E2E8F0",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{a.name}</div>
                      <div style={{fontSize:9,color:"var(--text3)",marginTop:2}}>{a.agent_id} · Lv.{a.level||1}</div>
                    </div>
                    <span style={{width:6,height:6,borderRadius:3,background:a.status==="online"?"var(--green)":"var(--red)"}} />
                  </div>
                </div>
              );
            })}
          </div>
        </>
      );
    }

    // ═══════════════════════════════════════════════════
    // AGENT PANEL (우측) — 3탭: 정보/통신/상태
    // ═══════════════════════════════════════════════════
    function AgentPanel({ agent:a, skills, catalog, onEquip, onUnequip, onLevelUp, onDelete, onRefreshAgents }) {
      const [tab, setTab] = useState("info");
      const [showSkillPicker, setShowSkillPicker] = useState(false);
      const [showReplicateModal, setShowReplicateModal] = useState(false);
      // 통신 상태
      const [inbox, setInbox] = useState([]);
      const [outbox, setOutbox] = useState([]);
      const [commStats, setCommStats] = useState(null);
      const [cmdSubject, setCmdSubject] = useState("");
      const [cmdBody, setCmdBody] = useState("");
      const [cmdPriority, setCmdPriority] = useState("normal");
      // 상태 머신
      const [stateInfo, setStateInfo] = useState(null);

      const c = getColor(a);
      const ic = getIcon(a);
      const equipped = a.equipped_skills || [];
      const equippedIds = equipped.map(s=>s.skill_id);
      const stats = a.stats || {INT:1,MEM:1,SPD:1,REL:1};
      const isMaster = a.role === "master_controller";
      const available = (catalog.length > 0 ? catalog : skills).filter(s => !equippedIds.includes(s.skill_id));

      const loadComm = () => {
        fetch(`${API}/api/agents/${a.agent_id}/inbox`).then(r=>r.json()).then(d=>setInbox(d.messages||[])).catch(()=>{});
        fetch(`${API}/api/agents/${a.agent_id}/outbox`).then(r=>r.json()).then(d=>setOutbox(d.messages||[])).catch(()=>{});
        fetch(`${API}/api/agents/${a.agent_id}/comm-stats`).then(r=>r.json()).then(setCommStats).catch(()=>{});
      };
      const loadState = () => {
        fetch(`${API}/api/agents/${a.agent_id}/state`).then(r=>r.json()).then(setStateInfo).catch(()=>{});
      };

      useEffect(() => {
        if (tab === "comm") loadComm();
        if (tab === "state") loadState();
      }, [tab, a.agent_id]);

      const sendCommand = () => {
        if (!cmdSubject.trim()) return;
        fetch(`${API}/api/messages/master-command`, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({to_id:a.agent_id, subject:cmdSubject, body:cmdBody, priority:cmdPriority})
        }).then(r=>r.json()).then(()=>{setCmdSubject(""); setCmdBody(""); loadComm();});
      };

      const doTransition = (newState) => {
        fetch(`${API}/api/agents/${a.agent_id}/state`, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({new_state:newState, reason:"dashboard"})
        }).then(r=>r.json()).then(d=>{
          if(d.success) { loadState(); if(onRefreshAgents) onRefreshAgents(); }
          else alert(d.message);
        });
      };

      const STATE_COLORS = {online:"var(--green)",dormant:"var(--yellow)",suspended:"var(--red)",training:"var(--accent2)",error:"var(--red)",terminated:"var(--text3)"};
      const TRANSITIONS_MAP = {
        online:["dormant","suspended","training","error"],
        dormant:["online","suspended"],
        suspended:["online"],
        training:["online","error"],
        error:["online","suspended"],
      };
      const currentState = stateInfo?.state || a.status || "online";
      const allowedTransitions = TRANSITIONS_MAP[currentState] || [];

      const tabStyle = (t) => ({
        flex:1, padding:"8px 0", textAlign:"center", fontSize:10, fontWeight:600, cursor:"pointer",
        borderBottom: tab===t ? "2px solid var(--accent)" : "2px solid transparent",
        color: tab===t ? "var(--accent)" : "var(--text3)", background:"transparent", border:"none",
        borderBottomWidth:2, borderBottomStyle:"solid", borderBottomColor: tab===t ? "var(--accent)" : "transparent",
        fontFamily:"inherit", letterSpacing:".08em"
      });

      return (
        <div style={{display:"flex",flexDirection:"column",height:"100%"}}>
          {/* Identity */}
          <div style={{padding:"16px 16px 0"}}>
            <div style={{display:"flex",alignItems:"center",gap:14,marginBottom:12}}>
              <div style={{width:48,height:48,borderRadius:14,border:`2px solid ${c}33`,background:`${c}08`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,fontFamily:"Syne",fontWeight:800,color:c}}>{ic}</div>
              <div style={{flex:1}}>
                <div style={{fontFamily:"Syne",fontWeight:700,fontSize:16,color:"#E2E8F0"}}>{a.name}</div>
                <div style={{fontSize:10,color:"var(--text3)",marginTop:2}}>{a.agent_id} · Lv.{a.level||1}</div>
              </div>
              <span style={{width:8,height:8,borderRadius:4,background:STATE_COLORS[a.status]||"var(--text3)"}} />
            </div>
          </div>

          {/* Tabs */}
          <div style={{display:"flex",borderBottom:"1px solid var(--border)",padding:"0 16px"}}>
            <button style={tabStyle("info")} onClick={()=>setTab("info")}>정보</button>
            <button style={tabStyle("comm")} onClick={()=>setTab("comm")}>통신</button>
            <button style={tabStyle("state")} onClick={()=>setTab("state")}>상태</button>
          </div>

          {/* Tab Content */}
          <div style={{flex:1,overflowY:"auto",padding:"16px"}}>

            {/* ── 정보 탭 ── */}
            {tab === "info" && (<>
              {/* Level */}
              <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:16,padding:"10px 14px",borderRadius:10,background:"var(--bg-2)",border:"1px solid var(--border)"}}>
                <div style={{textAlign:"center",flex:1}}>
                  <div style={{fontSize:9,color:"var(--text2)",letterSpacing:".1em",marginBottom:4}}>LEVEL</div>
                  <div style={{fontSize:28,fontFamily:"Syne",fontWeight:700,color:"var(--accent)"}}>{a.level||1}</div>
                </div>
              </div>

              {/* Stats */}
              <div style={{marginBottom:16}}>
                <div style={{fontSize:9,color:"var(--text2)",letterSpacing:".12em",fontWeight:600,marginBottom:8}}>STATS</div>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:5}}>
                  {[{k:"INT",c:"#6366F1"},{k:"MEM",c:"#06B6D4"},{k:"SPD",c:"#FBBF24"},{k:"REL",c:"#34D399"}].map(s => (
                    <div key={s.k} style={{padding:"8px 10px",borderRadius:8,background:"var(--bg-2)",border:"1px solid var(--border)"}}>
                      <div style={{fontSize:9,color:"var(--text3)",marginBottom:3}}>{s.k}</div>
                      <div style={{fontSize:18,fontFamily:"Syne",fontWeight:700,color:s.c}}>{stats[s.k]||0}</div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Equipped Skills */}
              <div style={{marginBottom:14}}>
                <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:6}}>
                  <span style={{fontSize:9,color:"var(--text2)",letterSpacing:".12em",fontWeight:600}}>SKILLS ({equipped.length})</span>
                  <button onClick={()=>setShowSkillPicker(!showSkillPicker)}
                    style={{padding:"3px 8px",borderRadius:5,border:"1px solid var(--border)",background:"transparent",color:"var(--accent)",cursor:"pointer",fontSize:9,fontFamily:"inherit"}}>
                    + 장착
                  </button>
                </div>
                {equipped.map(s => (
                  <div key={s.skill_id} style={{display:"flex",alignItems:"center",gap:8,padding:"7px 10px",borderRadius:8,background:"var(--bg-2)",border:"1px solid var(--border)",marginBottom:3}}>
                    <span style={{fontSize:13,color:CAT_COLOR[s.category]||"var(--text2)",fontFamily:"Syne"}}>{ICON_MAP[s.skill_id]||"⬡"}</span>
                    <div style={{flex:1,minWidth:0}}>
                      <div style={{fontSize:10,fontWeight:600,color:"var(--text)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{s.name}</div>
                      <div style={{fontSize:8,color:"var(--text3)"}}>{s.category}</div>
                    </div>
                    <button onClick={()=>onUnequip(a.agent_id, s.skill_id)}
                      style={{background:"none",border:"none",color:"var(--red)",cursor:"pointer",fontSize:11,fontFamily:"Syne",fontWeight:700,padding:"2px 5px"}}>✕</button>
                  </div>
                ))}
                {showSkillPicker && available.length > 0 && (
                  <div style={{marginTop:6,padding:6,borderRadius:8,background:"var(--bg-0)",border:"1px solid var(--border)"}}>
                    <div style={{fontSize:9,color:"var(--text2)",marginBottom:4}}>사용 가능한 스킬</div>
                    {available.map(s => (
                      <button key={s.skill_id} onClick={()=>{onEquip(a.agent_id,s.skill_id); setShowSkillPicker(false);}}
                        style={{display:"flex",alignItems:"center",gap:6,width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid var(--border)",background:"transparent",cursor:"pointer",fontFamily:"inherit",marginBottom:2,textAlign:"left"}}
                        onMouseOver={e=>e.currentTarget.style.background="var(--bg-2)"} onMouseOut={e=>e.currentTarget.style.background="transparent"}>
                        <span style={{fontSize:11,color:"var(--text2)"}}>{ICON_MAP[s.skill_id]||"⬡"}</span>
                        <div>
                          <div style={{fontSize:9,color:"var(--text)"}}>{s.name}</div>
                          <div style={{fontSize:8,color:"var(--text3)"}}>{s.category}</div>
                        </div>
                      </button>
                    ))}
                  </div>
                )}
              </div>

              {/* Level Up */}
              <div style={{display:"flex",gap:5,marginBottom:10}}>
                <button onClick={()=>onLevelUp(a.agent_id, false)}
                  style={{flex:1,padding:"9px",borderRadius:8,border:"1px solid var(--border)",background:"var(--bg-2)",color:"var(--accent)",cursor:"pointer",fontSize:10,fontFamily:"inherit",fontWeight:600}}>
                  레벨업 심사
                </button>
                <button onClick={()=>onLevelUp(a.agent_id, true)}
                  style={{padding:"9px 12px",borderRadius:8,border:"1px solid var(--border)",background:"var(--bg-2)",color:"var(--yellow)",cursor:"pointer",fontSize:10,fontFamily:"inherit",fontWeight:600}}>
                  강제↑
                </button>
              </div>

              {/* Replicate + Delete */}
              {!isMaster && (
                <div style={{display:"flex",gap:5,marginBottom:10}}>
                  <button onClick={()=>setShowReplicateModal(true)}
                    style={{flex:1,padding:"9px",borderRadius:8,border:"1px solid var(--accent2)33",background:"#6366F10A",color:"var(--accent2)",cursor:"pointer",fontSize:10,fontFamily:"inherit",fontWeight:600}}>
                    복제
                  </button>
                  <button onClick={()=>onDelete(a.agent_id)}
                    style={{flex:1,padding:"9px",borderRadius:8,border:"1px solid #EF444433",background:"#EF44440A",color:"var(--red)",cursor:"pointer",fontSize:10,fontFamily:"inherit"}}>
                    삭제
                  </button>
                </div>
              )}
            </>)}

            {/* ── 통신 탭 ── */}
            {tab === "comm" && (<>
              {/* 통신 통계 */}
              {commStats && (
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:5,marginBottom:14}}>
                  {[
                    {l:"수신",v:commStats.total_received,c:"#06B6D4"},
                    {l:"발신",v:commStats.total_sent,c:"#FB923C"},
                    {l:"대기",v:commStats.pending,c:"var(--yellow)"},
                  ].map(s=>(
                    <div key={s.l} style={{padding:"8px",borderRadius:8,background:"var(--bg-2)",border:"1px solid var(--border)",textAlign:"center"}}>
                      <div style={{fontSize:8,color:"var(--text3)",marginBottom:3}}>{s.l}</div>
                      <div style={{fontSize:16,fontFamily:"Syne",fontWeight:700,color:s.c}}>{s.v}</div>
                    </div>
                  ))}
                </div>
              )}

              {/* 명령 전송 폼 (마스터→워커 전용) */}
              {!isMaster && (
                <div style={{marginBottom:14,padding:10,borderRadius:8,background:"var(--bg-2)",border:"1px solid var(--border)"}}>
                  <div style={{fontSize:9,color:"var(--text2)",letterSpacing:".1em",fontWeight:600,marginBottom:8}}>SEND COMMAND</div>
                  <input value={cmdSubject} onChange={e=>setCmdSubject(e.target.value)} placeholder="제목"
                    style={{width:"100%",padding:"7px 10px",borderRadius:6,border:"1px solid var(--border)",background:"var(--bg-1)",color:"#E2E8F0",fontSize:11,fontFamily:"inherit",marginBottom:5,boxSizing:"border-box",outline:"none"}} />
                  <textarea value={cmdBody} onChange={e=>setCmdBody(e.target.value)} placeholder="내용" rows={2}
                    style={{width:"100%",padding:"7px 10px",borderRadius:6,border:"1px solid var(--border)",background:"var(--bg-1)",color:"#E2E8F0",fontSize:11,fontFamily:"inherit",marginBottom:5,boxSizing:"border-box",outline:"none",resize:"none"}} />
                  <div style={{display:"flex",gap:5}}>
                    <select value={cmdPriority} onChange={e=>setCmdPriority(e.target.value)}
                      style={{flex:1,padding:"6px 8px",borderRadius:6,border:"1px solid var(--border)",background:"var(--bg-1)",color:"var(--text)",fontSize:10,fontFamily:"inherit"}}>
                      <option value="low">low</option>
                      <option value="normal">normal</option>
                      <option value="high">high</option>
                      <option value="critical">critical</option>
                    </select>
                    <button onClick={sendCommand} disabled={!cmdSubject.trim()}
                      style={{padding:"6px 14px",borderRadius:6,border:"none",background:cmdSubject.trim()?"var(--accent)":"var(--border)",color:cmdSubject.trim()?"#fff":"var(--text3)",cursor:cmdSubject.trim()?"pointer":"default",fontSize:10,fontFamily:"Syne",fontWeight:700}}>
                      전송
                    </button>
                  </div>
                </div>
              )}

              {/* Inbox */}
              <div style={{marginBottom:12}}>
                <div style={{fontSize:9,color:"var(--text2)",letterSpacing:".1em",fontWeight:600,marginBottom:6}}>INBOX ({inbox.length})</div>
                {inbox.length === 0 && <div style={{fontSize:10,color:"var(--text3)",padding:"8px 0"}}>수신 메시지 없음</div>}
                {inbox.slice().reverse().slice(0,10).map(m => (
                  <div key={m.msg_id} style={{padding:"8px 10px",borderRadius:8,background:"var(--bg-2)",border:"1px solid var(--border)",marginBottom:3}}>
                    <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
                      <span style={{fontSize:10,fontWeight:600,color:"var(--text)"}}>{m.subject}</span>
                      <span style={{fontSize:8,color: m.status==="completed"?"var(--green)":m.status==="failed"?"var(--red)":"var(--yellow)"}}>{m.status}</span>
                    </div>
                    <div style={{fontSize:9,color:"var(--text3)"}}>{m.from} · {m.type} · {m.priority}</div>
                  </div>
                ))}
              </div>

              {/* Outbox */}
              <div>
                <div style={{fontSize:9,color:"var(--text2)",letterSpacing:".1em",fontWeight:600,marginBottom:6}}>OUTBOX ({outbox.length})</div>
                {outbox.length === 0 && <div style={{fontSize:10,color:"var(--text3)",padding:"8px 0"}}>발신 메시지 없음</div>}
                {outbox.slice().reverse().slice(0,10).map(m => (
                  <div key={m.msg_id} style={{padding:"8px 10px",borderRadius:8,background:"var(--bg-2)",border:"1px solid var(--border)",marginBottom:3}}>
                    <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
                      <span style={{fontSize:10,fontWeight:600,color:"var(--text)"}}>{m.subject}</span>
                      <span style={{fontSize:8,color:"var(--text3)"}}>{m.status}</span>
                    </div>
                    <div style={{fontSize:9,color:"var(--text3)"}}>→ {m.to} · {m.type}</div>
                  </div>
                ))}
              </div>
            </>)}

            {/* ── 상태 탭 ── */}
            {tab === "state" && (<>
              {/* 현재 상태 */}
              <div style={{textAlign:"center",marginBottom:16,padding:"14px",borderRadius:10,background:"var(--bg-2)",border:"1px solid var(--border)"}}>
                <div style={{fontSize:9,color:"var(--text2)",letterSpacing:".1em",marginBottom:6}}>CURRENT STATE</div>
                <div style={{fontSize:22,fontFamily:"Syne",fontWeight:800,color:STATE_COLORS[currentState]||"var(--text)"}}>{currentState.toUpperCase()}</div>
              </div>

              {/* 전이 버튼 */}
              <div style={{marginBottom:16}}>
                <div style={{fontSize:9,color:"var(--text2)",letterSpacing:".1em",fontWeight:600,marginBottom:8}}>TRANSITION</div>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:5}}>
                  {["online","dormant","suspended","training","error"].map(s => {
                    const allowed = allowedTransitions.includes(s);
                    const isCurrent = s === currentState;
                    return (
                      <button key={s} onClick={()=>allowed && doTransition(s)} disabled={!allowed || isCurrent}
                        style={{
                          padding:"8px 6px",borderRadius:8,fontSize:10,fontFamily:"inherit",fontWeight:600,cursor:allowed&&!isCurrent?"pointer":"default",
                          border: isCurrent ? `1.5px solid ${STATE_COLORS[s]}` : "1px solid var(--border)",
                          background: isCurrent ? `${STATE_COLORS[s]}12` : "var(--bg-2)",
                          color: allowed||isCurrent ? STATE_COLORS[s]||"var(--text)" : "var(--text3)",
                          opacity: allowed||isCurrent ? 1 : 0.4,
                        }}>
                        {s}
                      </button>
                    );
                  })}
                </div>
              </div>

              {/* 상태 히스토리 */}
              <div>
                <div style={{fontSize:9,color:"var(--text2)",letterSpacing:".1em",fontWeight:600,marginBottom:6}}>HISTORY</div>
                {(!stateInfo?.history || stateInfo.history.length === 0) && (
                  <div style={{fontSize:10,color:"var(--text3)",padding:"8px 0"}}>전이 기록 없음</div>
                )}
                {(stateInfo?.history||[]).slice().reverse().map((line,i) => (
                  <div key={i} style={{padding:"6px 8px",borderRadius:6,background:"var(--bg-2)",marginBottom:2,fontSize:9,color:"var(--text2)",fontFamily:"DM Mono",wordBreak:"break-all"}}>
                    {line}
                  </div>
                ))}
              </div>
            </>)}
          </div>

          {/* Replicate Modal */}
          {showReplicateModal && <ReplicateModal sourceId={a.agent_id} sourceName={a.name}
            onClose={()=>setShowReplicateModal(false)} onDone={()=>{setShowReplicateModal(false); if(onRefreshAgents) onRefreshAgents();}} />}
        </div>
      );
    }

    // ═══════════════════════════════════════════════════
    // REPLICATE MODAL
    // ═══════════════════════════════════════════════════
    function ReplicateModal({ sourceId, sourceName, onClose, onDone }) {
      const [newName, setNewName] = useState(`${sourceName}_clone`);
      const [inheritSkills, setInheritSkills] = useState(true);
      const [loading, setLoading] = useState(false);

      const doReplicate = () => {
        if (!newName.trim() || loading) return;
        setLoading(true);
        fetch(`${API}/api/agents/replicate`, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({source_id:sourceId, new_name:newName.trim(), inherit_skills:inheritSkills, inherit_level:false})
        }).then(r=>r.json()).then(d=>{
          setLoading(false);
          if(d.success) onDone();
          else alert(d.message||"복제 실패");
        }).catch(()=>setLoading(false));
      };

      return (
        <div style={{position:"fixed",inset:0,zIndex:100,display:"flex",alignItems:"center",justifyContent:"center"}}
          onClick={e=>{if(e.target===e.currentTarget) onClose();}}>
          <div style={{position:"absolute",inset:0,background:"#00000088",backdropFilter:"blur(4px)"}} />
          <div style={{position:"relative",width:"90%",maxWidth:360,background:"var(--bg-1)",borderRadius:14,border:"1px solid var(--border)",padding:"24px 28px",zIndex:1}}>
            <h3 style={{fontFamily:"Syne",fontWeight:700,fontSize:16,color:"#E2E8F0",margin:"0 0 4px"}}>REPLICATE</h3>
            <p style={{color:"var(--text3)",fontSize:10,margin:"0 0 16px"}}>{sourceId} ({sourceName}) 복제</p>

            <div style={{marginBottom:12}}>
              <label style={{fontSize:9,color:"var(--text2)",letterSpacing:".1em",fontWeight:600,display:"block",marginBottom:4}}>NEW NAME</label>
              <input value={newName} onChange={e=>setNewName(e.target.value)} autoFocus
                style={{width:"100%",padding:"10px 14px",borderRadius:8,border:"1.5px solid var(--border)",background:"var(--bg-2)",color:"#E2E8F0",fontSize:13,fontFamily:"Syne",boxSizing:"border-box",outline:"none"}}
                onFocus={e=>e.target.style.borderColor="#6366F155"} onBlur={e=>e.target.style.borderColor="var(--border)"} />
            </div>

            <div style={{marginBottom:16}}>
              <button onClick={()=>setInheritSkills(!inheritSkills)}
                style={{display:"flex",alignItems:"center",gap:8,width:"100%",padding:"10px 14px",borderRadius:8,
                  border:inheritSkills ? "1.5px solid #6366F133" : "1.5px solid var(--border)",
                  background:inheritSkills ? "#6366F108" : "var(--bg-2)",cursor:"pointer",textAlign:"left",fontFamily:"inherit"}}>
                <div style={{width:30,height:16,borderRadius:8,background:inheritSkills ? "var(--accent2)" : "var(--border)",position:"relative",transition:"background .2s"}}>
                  <div style={{width:12,height:12,borderRadius:6,background:"#fff",position:"absolute",top:2,left:inheritSkills?16:2,transition:"left .2s"}} />
                </div>
                <span style={{fontSize:10,color:inheritSkills ? "var(--accent2)" : "var(--text3)"}}>스킬 상속</span>
              </button>
            </div>

            <div style={{display:"flex",gap:6}}>
              <button onClick={onClose}
                style={{flex:1,padding:"10px",borderRadius:8,border:"1px solid var(--border)",background:"transparent",color:"var(--text2)",cursor:"pointer",fontFamily:"inherit",fontSize:11}}>취소</button>
              <button onClick={doReplicate} disabled={!newName.trim()||loading}
                style={{flex:2,padding:"10px",borderRadius:8,border:"none",
                  background:newName.trim()&&!loading?"var(--accent2)":"var(--border)",
                  color:newName.trim()&&!loading?"#fff":"var(--text3)",
                  cursor:newName.trim()&&!loading?"pointer":"not-allowed",
                  fontFamily:"Syne",fontWeight:700,fontSize:12}}>
                {loading ? "복제 중..." : "복제 실행"}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ═══════════════════════════════════════════════════
    // CREATE MODAL
    // ═══════════════════════════════════════════════════
    function CreateModal({ onClose, onCreate, hasMaster }) {
      const [name, setName] = useState("");
      const [role, setRole] = useState("general");
      const [isMaster, setIsMaster] = useState(false);

      return (
        <div style={{position:"fixed",inset:0,zIndex:100,display:"flex",alignItems:"center",justifyContent:"center"}}
          onClick={e=>{if(e.target===e.currentTarget) onClose();}}>
          <div style={{position:"absolute",inset:0,background:"#00000088",backdropFilter:"blur(4px)"}} />
          <div style={{position:"relative",width:"92%",maxWidth:420,background:"var(--bg-1)",borderRadius:16,border:"1px solid var(--border)",padding:"24px 20px",zIndex:1}}>
            <h2 style={{fontFamily:"Syne",fontWeight:800,fontSize:20,color:"#E2E8F0",margin:"0 0 6px"}}>
              {isMaster ? "★ MASTER AGENT" : "NEW AGENT"}
            </h2>
            <p style={{color:"var(--text3)",fontSize:11,margin:"0 0 20px"}}>
              {isMaster ? "시스템 총괄 에이전트" : "Level 1 초기 상태로 생산됩니다"}
            </p>

            <div style={{marginBottom:16}}>
              <label style={{fontSize:9,color:"var(--text2)",letterSpacing:".12em",fontWeight:600,display:"block",marginBottom:6}}>NAME</label>
              <input value={name} onChange={e=>setName(e.target.value)} placeholder="에이전트 이름" autoFocus
                style={{width:"100%",padding:"12px 16px",borderRadius:10,border:"1.5px solid var(--border)",background:"var(--bg-2)",color:"#E2E8F0",fontSize:14,fontFamily:"Syne",boxSizing:"border-box",outline:"none"}}
                onFocus={e=>e.target.style.borderColor="#ff6b2b55"} onBlur={e=>e.target.style.borderColor="var(--border)"} />
            </div>

            {!isMaster && (
              <div style={{marginBottom:16}}>
                <label style={{fontSize:9,color:"var(--text2)",letterSpacing:".12em",fontWeight:600,display:"block",marginBottom:6}}>ROLE</label>
                <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:4}}>
                  {ROLES.map(r => (
                    <button key={r.v} onClick={()=>setRole(r.v)}
                      style={{padding:"8px 4px",borderRadius:8,textAlign:"center",
                        border:role===r.v ? `1.5px solid ${r.color}55` : "1.5px solid var(--border)",
                        background:role===r.v ? `${r.color}0A` : "var(--bg-2)",
                        color:role===r.v ? r.color : "var(--text3)",
                        cursor:"pointer",fontSize:10,fontFamily:"inherit"}}>
                      <div style={{fontSize:14,marginBottom:2,fontFamily:"Syne"}}>{r.ic}</div>
                      {r.l}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {!hasMaster && (
              <div style={{marginBottom:20}}>
                <button onClick={()=>setIsMaster(!isMaster)}
                  style={{display:"flex",alignItems:"center",gap:10,width:"100%",padding:"12px 16px",borderRadius:10,
                    border:isMaster ? "1.5px solid #ff6b2b33" : "1.5px solid var(--border)",
                    background:isMaster ? "#ff6b2b08" : "var(--bg-2)",cursor:"pointer",textAlign:"left",fontFamily:"inherit"}}>
                  <div style={{width:34,height:18,borderRadius:9,background:isMaster ? "var(--accent)" : "var(--border)",position:"relative",transition:"background .2s"}}>
                    <div style={{width:14,height:14,borderRadius:7,background:"#fff",position:"absolute",top:2,left:isMaster?18:2,transition:"left .2s"}} />
                  </div>
                  <div>
                    <div style={{fontSize:11,color:isMaster ? "var(--accent)" : "var(--text2)",fontWeight:600}}>마스터 에이전트</div>
                    <div style={{fontSize:9,color:"var(--text3)",marginTop:1}}>최초 1회만 가능</div>
                  </div>
                </button>
              </div>
            )}

            <div style={{display:"flex",gap:8}}>
              <button onClick={onClose}
                style={{flex:1,padding:"12px",borderRadius:10,border:"1.5px solid var(--border)",background:"transparent",color:"var(--text2)",cursor:"pointer",fontFamily:"inherit",fontSize:12}}>취소</button>
              <button onClick={()=>{if(name.trim()) onCreate(name.trim(), isMaster?"master_controller":role, isMaster);}} disabled={!name.trim()}
                style={{flex:2,padding:"12px",borderRadius:10,border:"none",
                  background:name.trim() ? "var(--accent)" : "var(--border)",
                  color:name.trim() ? "#fff" : "var(--text3)",
                  cursor:name.trim()?"pointer":"not-allowed",
                  fontFamily:"Syne",fontWeight:700,fontSize:13}}>
                {isMaster ? "★ PRODUCE MASTER" : "⬡ PRODUCE AGENT"}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ─── RENDER ──────────────────────────────────────
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
